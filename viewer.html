<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 옹벽 뷰어</title>
    
    <!-- 스타일시트 -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/icons.css">
    <link rel="stylesheet" href="css/hotspot.css">
    <link rel="stylesheet" href="css/hotspot-sprite.css">
    <link rel="stylesheet" href="css/sensor-chart.css">
    <link rel="stylesheet" href="css/progressive-loading.css">
</head>
<body>
    <!-- 향상된 로딩 UI -->
    <div id="loading-enhanced" class="loading-enhanced">
        <div class="loading-content">
            <div class="loading-preview">
                <div class="loading-skeleton"></div>
                <img id="loading-preview-img" alt="모델 프리뷰">
            </div>
            
            <div class="loading-info">
                <h3 class="loading-title" id="loading-title">3D 모델 로딩 중</h3>
                <p class="loading-subtitle" id="loading-subtitle">잠시만 기다려주세요...</p>
                
                <div class="loading-progress-text">
                    진행률: <span class="percentage" id="loading-percentage">0%</span>
                </div>
                
                <div class="loading-progress-bar">
                    <div class="loading-progress-fill" id="loading-progress"></div>
                </div>
                
                <div class="loading-stages" id="loading-stages">
                    <div class="loading-stage" data-stage="preview">
                        <span class="stage-icon">📸</span>
                        <span class="stage-label">프리뷰</span>
                    </div>
                    <div class="loading-stage" data-stage="model">
                        <span class="stage-icon">📦</span>
                        <span class="stage-label">모델</span>
                    </div>
                    <div class="loading-stage" data-stage="optimize">
                        <span class="stage-icon">⚡</span>
                        <span class="stage-label">최적화</span>
                    </div>
                    <div class="loading-stage" data-stage="complete">
                        <span class="stage-icon">✅</span>
                        <span class="stage-label">완료</span>
                    </div>
                </div>
                
                <div class="loading-error" id="loading-error" style="display: none;">
                    <span class="error-icon">⚠️</span>
                    <span class="error-message" id="loading-error-message"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 헤더 -->
    <header class="header">
        <div class="header-left">
            <button id="home-btn" class="header-btn" title="홈으로">
                <span data-icon="home"></span>
            </button>
            <h1>3D 옹벽 모델 뷰어</h1>
        </div>
        
        <!-- 모델 선택 버튼 (중앙) -->
        <div class="model-selector-top">
            <button class="model-btn-top active" data-model="0">
                <span class="model-icon">🧱</span>
                <span class="model-name">블록 옹벽</span>
            </button>
            <button class="model-btn-top" data-model="1">
                <span class="model-icon">🏗️</span>
                <span class="model-name">캔틸레버 옹벽</span>
            </button>
            <button class="model-btn-top" data-model="2">
                <span class="model-icon">🔧</span>
                <span class="model-name">MSE 옹벽</span>
            </button>
        </div>
        
        <div class="header-right">
            <button id="chart-toggle-btn" class="header-btn" title="센서 차트">
                <span data-icon="bar-chart-3"></span>
            </button>
            <button id="fullscreen-btn" class="header-btn" title="전체화면">
                <span data-icon="maximize-2"></span>
            </button>
            <button id="help-btn" class="header-btn" title="도움말">
                <span data-icon="help-circle"></span>
            </button>
        </div>
    </header>
    
    <!-- 메인 뷰어 영역 -->
    <main class="main-content">
        <div id="viewer" class="viewer-container"></div>
        
        <!-- 센서 차트 컨테이너 -->
        <div id="sensor-chart-container" class="sensor-chart-container">
            <div class="chart-header">
                <h3>센서 데이터 모니터링</h3>
                <button class="chart-close" id="chart-close-btn">
                    <span data-icon="x"></span>
                </button>
            </div>
            <div class="chart-content">
                <canvas id="sensor-chart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background: #00ff88;"></span>
                    <span>정상</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ffaa00;"></span>
                    <span>주의</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #ff4444;"></span>
                    <span>위험</span>
                </div>
            </div>
        </div>
        
        <!-- 플로팅 도움말 박스 -->
        <div id="help-floating" class="floating-box help-box">
            <div class="floating-header">
                <h3>조작법</h3>
                <button class="floating-close">
                    <span data-icon="x"></span>
                </button>
            </div>
            <div class="floating-content">
                <div class="help-section">
                    <h4><span data-icon="mouse-pointer"></span> 마우스 조작</h4>
                    <ul>
                        <li><strong>좌클릭 드래그:</strong> 화면 회전</li>
                        <li><strong>우클릭 드래그:</strong> 화면 이동</li>
                        <li><strong>휠 스크롤:</strong> 확대/축소</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h4><span data-icon="keyboard"></span> 키보드 단축키</h4>
                    <ul>
                        <li><strong>F:</strong> 전체화면</li>
                        <li><strong>R:</strong> 카메라 초기화</li>
                        <li><strong>G:</strong> 그리드 표시/숨김</li>
                        <li><strong>Space:</strong> 애니메이션 재생/정지</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 카메라 뷰 박스 -->
        <div id="camera-floating" class="floating-box camera-box">
            <div class="floating-header">
                <h3>카메라 뷰</h3>
                <button class="floating-close">
                    <span data-icon="x"></span>
                </button>
            </div>
            <div class="floating-content camera-content">
                <div class="view-buttons">
                    <button class="view-btn active" data-view="perspective">
                        <span data-icon="eye"></span>
                        <span>원근</span>
                    </button>
                    <button class="view-btn" data-view="top">
                        <span data-icon="eye"></span>
                        <span>평면</span>
                    </button>
                    <button class="view-btn" data-view="front">
                        <span data-icon="eye"></span>
                        <span>정면</span>
                    </button>
                    <button class="view-btn" data-view="side">
                        <span data-icon="eye"></span>
                        <span>측면</span>
                    </button>
                </div>
                
                <div class="camera-controls">
                    <button class="control-btn" id="reset-camera">
                        <span data-icon="refresh-ccw"></span>
                        <span>초기화</span>
                    </button>
                    <button class="control-btn video-btn" data-video="construction">
                        <span data-icon="video"></span>
                        <span>시공 영상</span>
                    </button>
                </div>
                
                <div class="speed-control">
                    <button class="speed-toggle">
                        <span>회전 속도</span>
                        <span class="toggle-icon" data-icon="chevron-down"></span>
                    </button>
                    <div class="speed-slider-container" style="display: none;">
                        <input type="range" id="rotation-speed" class="speed-slider" min="0.1" max="2" step="0.1" value="0.5">
                        <span class="speed-value">0.5x</span>
                    </div>
                </div>
                
                <div class="camera-selector">
                    <label for="camera-select">GLTF 카메라:</label>
                    <select id="camera-select" class="camera-select">
                        <option value="default">기본 카메라</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 핫스팟 필터 박스 -->
        <div id="hotspot-floating" class="floating-box hotspot-box" style="display: none;">
            <div class="floating-header">
                <h3>센서 필터</h3>
                <button class="floating-close">
                    <span data-icon="x"></span>
                </button>
            </div>
            <div class="floating-content">
                <label for="hotspot-filter">센서 타입:</label>
                <select id="hotspot-filter" class="hotspot-select">
                    <option value="all">모든 타입</option>
                    <option value="normal">정상</option>
                    <option value="warning">경고</option>
                    <option value="danger">위험</option>
                    <option value="active">활성 센서만</option>
                </select>
            </div>
        </div>
    </main>
    
    <!-- 애니메이션 타임라인 (하단) -->
    <div id="animation-timeline" class="timeline-container" style="display: none;">
        <button id="play-btn" class="timeline-btn" title="재생">
            <span data-icon="play"></span>
        </button>
        
        <div class="timeline-track">
            <input type="range" id="timeline-slider" class="timeline-slider" min="0" max="100" value="0">
            <div class="timeline-progress"></div>
        </div>
        
        <div class="timeline-time">
            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
        </div>
    </div>
    
    <!-- 로딩 화면 -->
    <div id="loading" class="loading-screen">
        <div class="loading-spinner"></div>
        <p class="loading-text">모델 로딩 중...</p>
    </div>
    
    <!-- 에러 화면 -->
    <div id="error" class="error-screen" style="display: none;">
        <div class="error-content">
            <h2>오류 발생</h2>
            <p id="error-message">모델을 로드할 수 없습니다.</p>
            <button onclick="location.reload()">다시 시도</button>
        </div>
    </div>
    
    <!-- 동영상 모달 -->
    <div id="video-modal" class="video-modal">
        <div class="video-modal-content">
            <div class="video-modal-header">
                <h3 id="video-title">옹벽 시공 영상</h3>
                <button class="video-modal-close" id="video-close">
                    <span data-icon="x"></span>
                </button>
            </div>
            <div class="video-modal-body">
                <video id="video-player" controls preload="metadata">
                    <source src="" type="video/mp4">
                    브라우저가 동영상 재생을 지원하지 않습니다.
                </video>
            </div>
        </div>
    </div>

    <!-- Three.js 로컬 파일 사용 -->
    <script src="js/three/three.min.js"></script>
    <script src="js/three/GLTFLoader.js"></script>
    <script src="js/three/OrbitControls.js"></script>
    <script src="js/three/CSS2DRenderer.js"></script>

    <!-- Chart.js 로컬 파일 사용 -->
    <script src="js/libs/chart.umd.min.js"></script>

    <!-- 아이콘 로더 초기화 -->
    <script type="module">
        import { iconLoader } from './js/icon-loader.js';
        
        // 필요한 아이콘 프리로드
        await iconLoader.preloadIcons([
            'home', 'map-pin', 'bar-chart-3', 'maximize-2',
            'help-circle', 'play', 'pause', 'video', 'x',
            'chevron-down', 'chevron-up', 'refresh-ccw',
            'mouse-pointer', 'keyboard', 'eye', 'eye-off',
            'alert-triangle', 'info', 'grid-3x3'
        ]);
        
        // 전역 노출
        window.iconLoader = iconLoader;
        
        // DOM 로드 후 아이콘 교체
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async () => {
                await iconLoader.replaceAllIcons();
            });
        } else {
            await iconLoader.replaceAllIcons();
        }
    </script>

    <!-- 애플리케이션 스크립트 - app.js만 로드 -->
    <script type="module" src="js/app.js"></script>

</body>
</html>