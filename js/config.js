// js/config.js
// ÌÜµÌï© ÏÑ§Ï†ï ÌååÏùº - CONFIG Íµ¨Ï°∞ ÌÜµÏùº Î≤ÑÏ†Ñ

import { CONFIG_MANAGER, getConfig, setConfig } from './core/ConfigManager.js';

/**
 * Í∏∞Î≥∏ ÏÑ§Ï†ï Ï†ïÏùò
 * - ConfigManagerÏóê Îì±Î°ù
 * - ÌôòÍ≤ΩÎ≥Ñ ÏÑ§Ï†ï ÏûêÎèô Ï†ÅÏö©
 * - CONFIG Íµ¨Ï°∞ ÌÜµÏùº
 */
const initializeConfig = () => {
    // === Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Í∏∞Î≥∏ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('app', {
        name: 'Wall 3D Viewer',
        version: '2.0.0',
        debug: CONFIG_MANAGER.environment === 'development',
        enableCache: true
    });
    
    // === ÌÉÄÏù¥Î∞ç ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('timing', {
        maxRetryAttempts: 20,
        retryDelay: 100
    });
    
    // === Î™®Îç∏ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('models', {
        defaultModel: 0,
        enableCaching: true,
        maxCacheSize: 5,
        maxRetries: 3,
        retryDelay: 1000,
        fallbackModels: [],
        enableFallback: true,
        enableStreaming: false,
        enablePreloading: true,
        maxConcurrentLoads: 3,
        textureOptimization: true,
        enableDracoLoader: true,
        dracoDecoderPath: './libs/draco/',
        enableKTX2Loader: false,
        ktx2TranscoderPath: './libs/basis/',
        enableShadows: true,
        enableLOD: false,
        maxAnisotropy: 4,
        defaultModels: [
            {
                name: 'Î∏îÎ°ù ÏòπÎ≤Ω',
                folder: 'Block_Retaining_Wall',
                fileName: 'Block_Retaining_Wall.gltf',
                icon: 'üß±',
                description: 'ÏΩòÌÅ¨Î¶¨Ìä∏ Î∏îÎ°ùÏùÑ Ïù¥Ïö©Ìïú Ï°∞Î¶ΩÏãù ÏòπÎ≤Ω'
            },
            {
                name: 'Ï∫îÌã∏Î†àÎ≤Ñ ÏòπÎ≤Ω',
                folder: 'Cantilever_Retaining_Wall',
                fileName: 'Cantilever_Retaining_Wall.gltf',
                icon: 'üèóÔ∏è',
                description: 'Ï≤†Í∑º ÏΩòÌÅ¨Î¶¨Ìä∏ ÏùºÏ≤¥Ìòï ÏòπÎ≤Ω'
            },
            {
                name: 'MSE ÏòπÎ≤Ω',
                folder: 'mse_Retaining_Wall',
                fileName: 'mse_Retaining_Wall.gltf',
                icon: 'üîß',
                description: 'Î≥¥Í∞ïÌÜ† ÏòπÎ≤Ω (Mechanically Stabilized Earth)'
            }
        ]
    });
    
    // === Í≤ΩÎ°ú ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('paths', {
        modelsPath: './gltf/',
        texturesPath: './textures/',
        pluginsPath: './js/plugins/'
    });
    
    // === Ïî¨ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('scene', {
        backgroundColor: 0x1a1a1a,
        fogEnabled: true,
        fogColor: 0x1a1a1a,
        fogNear: 10,
        fogFar: 100
    });
    
    // === Ïπ¥Î©îÎùº ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('camera', {
        fov: 45,
        near: 0.1,
        far: 1000,
        position: { x: 5, y: 5, z: 10 },
        lookAt: { x: 0, y: 0, z: 0 }
    });
    
    // === Ïª®Ìä∏Î°§ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('controls', {
        enabled: true,
        enableDamping: true,
        dampingFactor: 0.1,
        
        // ÌöåÏ†Ñ ÏÑ§Ï†ï
        rotateSpeed: 0.5,
        autoRotate: false,
        autoRotateSpeed: 2.0,
        
        // Ï§å ÏÑ§Ï†ï
        enableZoom: true,
        zoomSpeed: 0.5,
        minDistance: 2,
        maxDistance: 100,
        
        // Ìå¨ ÏÑ§Ï†ï
        enablePan: true,
        panSpeed: 0.5,
        screenSpacePanning: true,
        
        // Ï†úÌïú ÏÑ§Ï†ï
        minPolarAngle: 0,
        maxPolarAngle: Math.PI * 0.9
    });
    
    // === Î†åÎçîÎü¨ ÏÑ§Ï†ï - CONFIG Íµ¨Ï°∞ ÌÜµÏùº ===
    CONFIG_MANAGER.setConfig('renderer', {
        antialias: true,
        alpha: false,
        preserveDrawingBuffer: false,
        powerPreference: "high-performance",
        
        // shadowMapÏùÑ Í∞ùÏ≤¥Î°ú ÏÑ§Ï†ï
        shadowMap: {
            enabled: true,
            type: 'PCFSoftShadowMap',
            autoUpdate: true
        },
        
        // ÌÜ§Îß§Ìïë ÏÑ§Ï†ï
        toneMapping: 'ACESFilmicToneMapping',
        toneMappingExposure: 1.0,
        
        // ÏÉâÏÉÅ Í≥µÍ∞Ñ
        outputEncoding: 'sRGBEncoding',
        
        // ÌîΩÏÖÄ ÎπÑÏú®
        pixelRatio: window.devicePixelRatio || 1,
        
        // Î¨ºÎ¶¨ Í∏∞Î∞ò Î†åÎçîÎßÅ
        physicallyCorrectLights: true
    });
    
    // === Ï°∞Î™Ö ÏÑ§Ï†ï - CONFIG Íµ¨Ï°∞ ÌÜµÏùº ===
    CONFIG_MANAGER.setConfig('lights', {
        ambient: {
            color: 0x404040,
            intensity: CONFIG_MANAGER.environment === 'development' ? 0.8 : 0.6
        },
        directional: {
            color: 0xffffff,
            intensity: CONFIG_MANAGER.environment === 'development' ? 1.2 : 1.0,
            position: { x: 10, y: 10, z: 5 },
            castShadow: true,
            shadowMapSize: CONFIG_MANAGER.environment === 'development' ? 2048 : 1024,
            shadowCamera: {
                near: 0.5,
                far: 50,
                size: 20,
                left: -20,
                right: 20,
                top: 20,
                bottom: -20
            }
        },
        hemisphere: {
            skyColor: 0x87CEEB,
            groundColor: 0x362907,
            intensity: 0.6
        }
    });
    
    // === Ìó¨Ìçº ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('helpers', {
        grid: {
            enabled: true,
            visible: true,
            size: 50,
            divisions: 50,
            colorCenterLine: 0x444444,
            colorGrid: 0x222222
        },
        axes: {
            enabled: true,
            visible: CONFIG_MANAGER.environment === 'development',
            size: 10
        }
    });
    
    // === ÌôòÍ≤Ω ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('environment', {
        showFloor: true,
        floorSize: 100,
        floorColor: 0x202020,
        floorOpacity: 0.3,
        floorPosition: { x: 0, y: -0.001, z: 0 }
    });
    
    // === Ïï†ÎãàÎ©îÏù¥ÏÖò ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('animation', {
        defaultDuration: 3.0,
        defaultEasing: 'easeInOutQuad',
        enabledByDefault: true,
        showControls: true,
        loop: true
    });
    
    // === Ìï´Ïä§Ìåü ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('hotspots', {
        enabled: true,
        showLabels: true,
        labelMaxDistance: 50,
        defaultColor: '#007bff',
        hoverColor: '#0056b3',
        activeColor: '#28a745',
        animationDuration: 300,
        minScale: 0.5,
        maxScale: 1.5
    });
    
    // === UI ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('ui', {
        theme: 'dark',
        language: 'ko',
        showFPS: CONFIG_MANAGER.environment === 'development',
        showStats: CONFIG_MANAGER.environment === 'development',
        errorMessageDuration: 5000,
        successMessageDuration: 3000,
        animationSpeed: 300,
        rememberLastModel: true,
        updateInterval: 100,
        enablePerformanceMonitoring: true,
        elementDefaults: {},
        accessibility: {},
        parentMapping: {},
        components: {}
    });
    
    // === ÏÑ±Îä• ÏÑ§Ï†ï ===
    const performanceSettings = CONFIG_MANAGER.environment === 'production' ? {
        targetFPS: 60,
        minAcceptableFPS: 20,
        adaptiveQuality: true,
        enableMonitoring: true,
        logMetrics: false,
        maxTextureSize: 2048,
        enablePostProcessing: false,
        powerPreference: 'high-performance',
        LOD: {
            enabled: true,
            levels: [10, 30, 50]
        }
    } : {
        targetFPS: 60,
        minAcceptableFPS: 20,
        adaptiveQuality: false,
        enableMonitoring: true,
        logMetrics: true,
        maxTextureSize: 4096,
        enablePostProcessing: true,
        powerPreference: 'high-performance',
        LOD: {
            enabled: false,
            levels: []
        }
    };
    
    CONFIG_MANAGER.setConfig('performance', performanceSettings);
    
    // === ÌîåÎü¨Í∑∏Ïù∏ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('plugins', {
        enabled: true,
        autoLoad: ['LightingControl', 'MeasurementTool'],
        allowThirdParty: CONFIG_MANAGER.environment === 'development'
    });
    
    // === Í∞úÎ∞ú ÎèÑÍµ¨ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('devTools', {
        enabled: CONFIG_MANAGER.environment === 'development',
        showAxesHelper: true,
        showGridHelper: true,
        showLightHelpers: false,
        enableHotReload: true,
        logLevel: CONFIG_MANAGER.environment === 'development' ? 'debug' : 'error',
        gridSize: 100,
        gridDivisions: 100,
        axesSize: 5,
        showHelpers: CONFIG_MANAGER.environment === 'development'
    });
    
    // === Í∞ùÏ≤¥ Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('objectVisibility', {
        enableAnimations: true,
        animationDuration: 300,
        fadeInEasing: 'easeOut',
        fadeOutEasing: 'easeIn',
        enableGrouping: true,
        enableLayers: true,
        enableMaterialPreservation: true,
        enableHighlight: true,
        highlightColor: '#ffff00',
        highlightEmissive: 0.3
    });
    
    // === ÏóêÎü¨ Ï≤òÎ¶¨ ÏÑ§Ï†ï ===
    CONFIG_MANAGER.setConfig('errors', {
        autoRecovery: true,
        maxAutoRecoveryAttempts: 3,
        showUserErrors: true,
        logToConsole: CONFIG_MANAGER.environment === 'development',
        reportToServer: CONFIG_MANAGER.environment === 'production'
    });
};

// ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî Ïã§Ìñâ
initializeConfig();

/**
 * Í∏∞Ï°¥ CONFIG Í∞ùÏ≤¥ ÏÉùÏÑ± (ÌïòÏúÑ Ìò∏ÌôòÏÑ±)
 * - Í∏∞Ï°¥ ÏΩîÎìúÎäî Ïù¥ Í∞ùÏ≤¥Î•º Í≥ÑÏÜç ÏÇ¨Ïö© Í∞ÄÎä•
 * - ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°úÎäî ConfigManagerÏùò ÏÑ§Ï†ïÏùÑ Ï∞∏Ï°∞
 */
export const CONFIG = new Proxy({}, {
    get(target, prop) {
        // ÏßÅÏ†ë Îß§ÌïëÎêòÎäî ÏµúÏÉÅÏúÑ ÏÜçÏÑ±Îì§
        const directMappings = {
            'modelsPath': 'paths.modelsPath',
            'debug': 'app.debug',
            'camera': 'camera',
            'controls': 'controls',
            'renderer': 'renderer',
            'lights': 'lights',
            'helpers': 'helpers',
            'environment': 'environment',
            'scene': 'scene',
            'animation': 'animation',
            'hotspots': 'hotspots',
            'ui': 'ui',
            'performance': 'performance',
            'models': 'models.defaultModels'
        };
        
        if (directMappings[prop]) {
            return getConfig(directMappings[prop]);
        }
        
        // ÏùºÎ∞òÏ†ÅÏù∏ Í≤ΩÏö∞
        const value = getConfig(prop);
        if (value !== undefined) {
            return value;
        }
        
        // Ï§ëÏ≤©Îêú Í∞ùÏ≤¥ Ï≤òÎ¶¨
        return new Proxy({}, {
            get(subTarget, subProp) {
                return getConfig(`${prop}.${subProp}`);
            }
        });
    },
    
    set(target, prop, value) {
        setConfig(prop, value);
        return true;
    }
});

/**
 * Îü∞ÌÉÄÏûÑ ÏÑ§Ï†ï Î≥ÄÍ≤Ω Ìó¨Ìçº Ìï®ÏàòÎì§
 */

// ÎîîÎ≤ÑÍ∑∏ Î™®Îìú ÌÜ†Í∏Ä
export function toggleDebug() {
    const currentDebug = getConfig('app.debug');
    setConfig('app.debug', !currentDebug);
    console.log(`ÎîîÎ≤ÑÍ∑∏ Î™®Îìú: ${!currentDebug ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
}

// ÏÑ±Îä• Î™®Îìú ÏÑ§Ï†ï
export function setPerformanceMode(mode) {
    switch(mode) {
        case 'low':
            setConfig('performance.targetFPS', 30);
            setConfig('renderer.antialias', false);
            setConfig('renderer.shadowMap.enabled', false);
            break;
        case 'medium':
            setConfig('performance.targetFPS', 45);
            setConfig('renderer.antialias', true);
            setConfig('renderer.shadowMap.enabled', true);
            setConfig('lights.directional.shadowMapSize', 1024);
            break;
        case 'high':
            setConfig('performance.targetFPS', 60);
            setConfig('renderer.antialias', true);
            setConfig('renderer.shadowMap.enabled', true);
            setConfig('lights.directional.shadowMapSize', 2048);
            break;
    }
}

// ÌÖåÎßà Î≥ÄÍ≤Ω
export function setTheme(theme) {
    setConfig('ui.theme', theme);
    document.body.className = `theme-${theme}`;
}

// Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω
export function setLanguage(lang) {
    setConfig('ui.language', lang);
    // Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω Î°úÏßÅ Ï∂îÍ∞Ä Í∞ÄÎä•
}

/**
 * ÏÑ§Ï†ï Ï†ÄÏû•/Î≥µÏõê (Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ)
 */
export function saveSettings() {
    const settings = {
        ui: getConfig('ui'),
        performance: getConfig('performance'),
        controls: getConfig('controls')
    };
    
    try {
        localStorage.setItem('wall_viewer_settings', JSON.stringify(settings));
        console.log('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        return true;
    } catch (error) {
        console.error('ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®:', error);
        return false;
    }
}

export function loadSettings() {
    try {
        const saved = localStorage.getItem('wall_viewer_settings');
        if (saved) {
            const settings = JSON.parse(saved);
            
            // Ï†ÄÏû•Îêú ÏÑ§Ï†ï Ï†ÅÏö©
            if (settings.ui) {
                Object.entries(settings.ui).forEach(([key, value]) => {
                    setConfig(`ui.${key}`, value);
                });
            }
            
            if (settings.performance) {
                Object.entries(settings.performance).forEach(([key, value]) => {
                    setConfig(`performance.${key}`, value);
                });
            }
            
            if (settings.controls) {
                Object.entries(settings.controls).forEach(([key, value]) => {
                    setConfig(`controls.${key}`, value);
                });
            }
            
            console.log('ÏÑ§Ï†ïÏù¥ Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.');
            return true;
        }
    } catch (error) {
        console.error('ÏÑ§Ï†ï Î≥µÏõê Ïã§Ìå®:', error);
    }
    return false;
}

// ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
export function resetSettings() {
    localStorage.removeItem('wall_viewer_settings');
    CONFIG_MANAGER.resetToDefaults();
    console.log('ÏÑ§Ï†ïÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
}

// ÏûêÎèô ÏÑ§Ï†ï Î°úÎìú
if (getConfig('ui.rememberLastModel', true)) {
    loadSettings();
}

console.log('[Config] ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
console.log(`[Config] ÌôòÍ≤Ω: ${CONFIG_MANAGER.environment}`);
console.log(`[Config] ÎîîÎ≤ÑÍ∑∏ Î™®Îìú: ${getConfig('app.debug') ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}`);