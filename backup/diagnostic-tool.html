<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>옹벽 3D 뷰어 - 종합 진단 도구</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #00ff88;
            margin-top: 30px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .success { color: #00ff88; }
        .warning { color: #ffc107; }
        .error { color: #ff6b6b; }
        .info { color: #007bff; }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        button.success-btn {
            background: #00ff88;
            color: #1a1a1a;
        }
        
        button.warning-btn {
            background: #ffc107;
            color: #1a1a1a;
        }
        
        button.danger-btn {
            background: #ff6b6b;
        }
        
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .code-fix {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .code-fix h3 {
            margin-top: 0;
            color: #00ff88;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #00ff88);
            transition: width 0.3s ease;
        }
        
        #console-output {
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border-radius: 6px;
            border: 1px solid #333;
        }
        
        .tab-container {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            color: #888;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .tab.active {
            background: #007bff;
            color: white;
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .fix-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #00ff88;
            color: #1a1a1a;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 옹벽 3D 뷰어 - 종합 진단 도구</h1>
        
        <div class="section">
            <h2>1. 시스템 상태 검사</h2>
            <div id="system-status"></div>
            <button onclick="runSystemCheck()">전체 검사 실행</button>
            <button class="warning-btn" onclick="quickFix()">빠른 수정 시도</button>
        </div>
        
        <div class="section">
            <h2>2. 실시간 진단</h2>
            <div class="grid">
                <div>
                    <h3>Three.js</h3>
                    <div id="threejs-status"></div>
                </div>
                <div>
                    <h3>CONFIG</h3>
                    <div id="config-status"></div>
                </div>
                <div>
                    <h3>DOM 요소</h3>
                    <div id="dom-status"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>3. 모델 파일 검사</h2>
            <div id="model-files"></div>
            <button onclick="checkAllModels()">모든 모델 파일 검사</button>
            <button onclick="testLoadModel()">첫 번째 모델 로드 테스트</button>
        </div>
        
        <div class="section">
            <h2>4. 수정 도구</h2>
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('fix-config')">CONFIG 수정</button>
                    <button class="tab" onclick="showTab('fix-dom')">DOM 수정</button>
                    <button class="tab" onclick="showTab('fix-display')">표시 문제</button>
                </div>
                <div id="fix-config" class="tab-content active">
                    <h3>CONFIG 문제 해결</h3>
                    <button onclick="injectConfig()">CONFIG 강제 주입</button>
                    <button onclick="validateConfig()">CONFIG 검증</button>
                    <button onclick="showConfigEditor()">CONFIG 편집기</button>
                </div>
                <div id="fix-dom" class="tab-content">
                    <h3>DOM 요소 수정</h3>
                    <button onclick="createMissingElements()">누락된 요소 생성</button>
                    <button onclick="fixModelSelector()">모델 선택화면 수정</button>
                    <button onclick="rebuildUI()">UI 재구성</button>
                </div>
                <div id="fix-display" class="tab-content">
                    <h3>표시 문제 해결</h3>
                    <button onclick="forceShowSelector()">모델 선택화면 강제 표시</button>
                    <button onclick="manualModelList()">모델 목록 수동 생성</button>
                    <button onclick="resetStyles()">스타일 초기화</button>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>5. 콘솔 출력</h2>
            <div id="console-output"></div>
            <button onclick="clearConsole()">콘솔 지우기</button>
            <button onclick="exportLogs()">로그 내보내기</button>
        </div>
        
        <button class="fix-button" onclick="autoFix()">🚀 자동 수정 실행</button>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <script type="module">
        import { CONFIG } from './js/config.js';
        window.CONFIG = CONFIG;
    </script>
    
    <script>
        // 콘솔 출력 캡처
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        const originalError = console.error;
        const logs = [];
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logs.push({ type: 'log', message, time: new Date() });
            addConsoleMessage('log', message);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            logs.push({ type: 'error', message, time: new Date() });
            addConsoleMessage('error', message);
        };
        
        function addConsoleMessage(type, message) {
            const div = document.createElement('div');
            div.style.color = type === 'error' ? '#ff6b6b' : '#0f0';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // 시스템 검사
        function runSystemCheck() {
            const status = document.getElementById('system-status');
            const checks = [];
            
            // Three.js 체크
            checks.push({
                name: 'Three.js',
                status: typeof THREE !== 'undefined',
                version: typeof THREE !== 'undefined' ? THREE.REVISION : 'N/A'
            });
            
            // GLTFLoader 체크
            checks.push({
                name: 'GLTFLoader',
                status: typeof THREE !== 'undefined' && THREE.GLTFLoader !== undefined
            });
            
            // OrbitControls 체크
            checks.push({
                name: 'OrbitControls',
                status: typeof THREE !== 'undefined' && THREE.OrbitControls !== undefined
            });
            
            // CONFIG 체크
            checks.push({
                name: 'CONFIG',
                status: typeof CONFIG !== 'undefined',
                detail: typeof CONFIG !== 'undefined' ? `${CONFIG.models?.length || 0}개 모델` : 'N/A'
            });
            
            // WebGL 체크
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            checks.push({
                name: 'WebGL',
                status: !!gl
            });
            
            // DOM 요소 체크
            const requiredElements = ['model-selector', 'model-list', 'canvas-container'];
            requiredElements.forEach(id => {
                checks.push({
                    name: `DOM: ${id}`,
                    status: !!document.getElementById(id)
                });
            });
            
            // 결과 표시
            let html = '';
            checks.forEach(check => {
                const statusClass = check.status ? 'success' : 'error';
                const statusText = check.status ? '✓ 정상' : '✗ 오류';
                html += `
                    <div class="status-item">
                        <span>${check.name}</span>
                        <span class="${statusClass}">
                            ${statusText}
                            ${check.version ? ` (v${check.version})` : ''}
                            ${check.detail ? ` - ${check.detail}` : ''}
                        </span>
                    </div>
                `;
            });
            
            status.innerHTML = html;
            
            // 문제 요약
            const issues = checks.filter(c => !c.status);
            if (issues.length > 0) {
                status.innerHTML += `
                    <div class="code-fix">
                        <h3>발견된 문제: ${issues.length}개</h3>
                        <p>아래의 '빠른 수정' 버튼을 클릭하여 문제를 해결해보세요.</p>
                    </div>
                `;
            }
        }
        
        // 빠른 수정
        function quickFix() {
            console.log('빠른 수정 시작...');
            
            // CONFIG 확인 및 수정
            if (typeof CONFIG === 'undefined') {
                console.log('CONFIG가 없습니다. 기본값 생성...');
                window.CONFIG = {
                    modelsPath: 'gltf/',
                    models: [
                        {
                            name: '블록 옹벽',
                            folder: 'Block_Retaining_Wall',
                            fileName: 'Block_Retaining_Wall.gltf',
                            icon: '🧱',
                            description: '블록식 옹벽 구조'
                        },
                        {
                            name: '캔틸레버 옹벽',
                            folder: 'Cantilever_Retaining_Wall',
                            fileName: 'Cantilever_Retaining_Wall.gltf',
                            icon: '🏗️',
                            description: '캔틸레버식 옹벽 구조'
                        },
                        {
                            name: 'MSE 옹벽',
                            folder: 'mse_Retaining_Wall',
                            fileName: 'mse_Retaining_Wall.gltf',
                            icon: '🏛️',
                            description: 'MSE 옹벽'
                        }
                    ],
                    debug: true
                };
            }
            
            // DOM 요소 확인 및 생성
            createMissingElements();
            
            // 모델 선택화면 표시
            forceShowSelector();
            
            console.log('빠른 수정 완료!');
            
            // 다시 검사
            setTimeout(runSystemCheck, 500);
        }
        
        // 누락된 DOM 요소 생성
        function createMissingElements() {
            console.log('누락된 DOM 요소 확인 중...');
            
            const requiredElements = [
                {
                    id: 'model-selector',
                    html: '<div class="selector-container"><h1>모델 선택</h1><div id="model-list" class="model-list"></div></div>',
                    style: 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000;'
                },
                {
                    id: 'model-list',
                    parent: 'model-selector',
                    html: '',
                    style: 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;'
                },
                {
                    id: 'canvas-container',
                    html: '',
                    style: 'width: 100%; height: 100vh;'
                }
            ];
            
            requiredElements.forEach(elem => {
                if (!document.getElementById(elem.id)) {
                    console.log(`생성 중: ${elem.id}`);
                    const div = document.createElement('div');
                    div.id = elem.id;
                    div.innerHTML = elem.html;
                    div.style.cssText = elem.style;
                    
                    if (elem.parent && document.getElementById(elem.parent)) {
                        document.getElementById(elem.parent).appendChild(div);
                    } else {
                        document.body.appendChild(div);
                    }
                }
            });
        }
        
        // 모델 선택화면 강제 표시
        function forceShowSelector() {
            const selector = document.getElementById('model-selector');
            if (selector) {
                selector.style.display = 'flex';
                manualModelList();
                console.log('모델 선택화면 표시됨');
            } else {
                console.error('model-selector를 찾을 수 없습니다');
                createMissingElements();
                setTimeout(forceShowSelector, 100);
            }
        }
        
        // 모델 목록 수동 생성
        function manualModelList() {
            const modelList = document.getElementById('model-list');
            if (!modelList) return;
            
            const models = CONFIG?.models || [
                { name: '블록 옹벽', icon: '🧱', description: '테스트 모델 1' },
                { name: '캔틸레버 옹벽', icon: '🏗️', description: '테스트 모델 2' },
                { name: 'MSE 옹벽', icon: '🏛️', description: '테스트 모델 3' }
            ];
            
            modelList.innerHTML = '';
            models.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.style.cssText = 'background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; cursor: pointer; text-align: center;';
                card.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">${model.icon}</div>
                    <div style="font-weight: bold; margin-bottom: 5px;">${model.name}</div>
                    <div style="font-size: 14px; color: #888;">${model.description}</div>
                `;
                card.onclick = () => {
                    console.log(`모델 선택됨: ${model.name}`);
                    alert(`${model.name} 선택됨 - 실제 앱에서는 모델이 로드됩니다.`);
                };
                modelList.appendChild(card);
            });
            
            console.log(`${models.length}개 모델 카드 생성됨`);
        }
        
        // 모든 모델 파일 검사
        async function checkAllModels() {
            const modelFiles = document.getElementById('model-files');
            modelFiles.innerHTML = '<p>모델 파일 검사 중...</p>';
            
            if (!CONFIG?.models) {
                modelFiles.innerHTML = '<p class="error">CONFIG.models가 정의되지 않았습니다.</p>';
                return;
            }
            
            let html = '<table style="width: 100%;">';
            html += '<tr><th>모델명</th><th>경로</th><th>상태</th></tr>';
            
            for (const model of CONFIG.models) {
                const path = `${CONFIG.modelsPath}${model.folder}/${model.fileName}`;
                let status = '확인 중...';
                let statusClass = 'warning';
                
                try {
                    const response = await fetch(path, { method: 'HEAD' });
                    if (response.ok) {
                        status = '✓ 존재';
                        statusClass = 'success';
                    } else {
                        status = `✗ 오류 (${response.status})`;
                        statusClass = 'error';
                    }
                } catch (error) {
                    status = '✗ 접근 불가';
                    statusClass = 'error';
                }
                
                html += `
                    <tr>
                        <td>${model.name}</td>
                        <td style="font-size: 12px;">${path}</td>
                        <td class="${statusClass}">${status}</td>
                    </tr>
                `;
            }
            
            html += '</table>';
            modelFiles.innerHTML = html;
        }
        
        // 탭 전환
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // 자동 수정
        async function autoFix() {
            console.log('=== 자동 수정 시작 ===');
            
            // 1. 시스템 검사
            runSystemCheck();
            
            // 2. CONFIG 수정
            if (typeof CONFIG === 'undefined') {
                injectConfig();
            }
            
            // 3. DOM 수정
            createMissingElements();
            
            // 4. 스타일 수정
            resetStyles();
            
            // 5. 모델 선택화면 표시
            setTimeout(() => {
                forceShowSelector();
                console.log('=== 자동 수정 완료 ===');
                
                // index.html로 이동 옵션
                if (confirm('수정이 완료되었습니다. index.html로 이동하시겠습니까?')) {
                    window.location.href = 'index.html';
                }
            }, 1000);
        }
        
        // CONFIG 강제 주입
        function injectConfig() {
            console.log('CONFIG 강제 주입...');
            const script = document.createElement('script');
            script.textContent = `
                window.CONFIG = {
                    modelsPath: 'gltf/',
                    models: [
                        {
                            name: '블록 옹벽',
                            folder: 'Block_Retaining_Wall',
                            fileName: 'Block_Retaining_Wall.gltf',
                            icon: '🧱',
                            description: '블록식 옹벽 구조'
                        },
                        {
                            name: '캔틸레버 옹벽',
                            folder: 'Cantilever_Retaining_Wall',
                            fileName: 'Cantilever_Retaining_Wall.gltf',
                            icon: '🏗️',
                            description: '캔틸레버식 옹벽 구조'
                        },
                        {
                            name: 'MSE 옹벽',
                            folder: 'mse_Retaining_Wall',
                            fileName: 'mse_Retaining_Wall.gltf',
                            icon: '🏛️',
                            description: 'MSE 옹벽'
                        }
                    ],
                    debug: true
                };
            `;
            document.head.appendChild(script);
            console.log('CONFIG 주입 완료');
        }
        
        // 스타일 초기화
        function resetStyles() {
            console.log('스타일 초기화...');
            const style = document.createElement('style');
            style.textContent = `
                .model-selector {
                    display: flex !important;
                }
                .model-card {
                    cursor: pointer !important;
                    transition: all 0.3s ease !important;
                }
                .model-card:hover {
                    transform: translateY(-5px) !important;
                    box-shadow: 0 5px 20px rgba(0,123,255,0.3) !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 콘솔 지우기
        function clearConsole() {
            consoleOutput.innerHTML = '';
            logs.length = 0;
            console.clear();
        }
        
        // 로그 내보내기
        function exportLogs() {
            const logText = logs.map(log => 
                `[${log.time.toISOString()}] ${log.type.toUpperCase()}: ${log.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wall-viewer-logs-${new Date().toISOString()}.txt`;
            a.click();
        }
        
        // 초기 실행
        setTimeout(() => {
            runSystemCheck();
            console.log('진단 도구 준비 완료');
        }, 500);
    </script>
</body>
</html>